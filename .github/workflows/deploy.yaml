name: Deploy
run-name: Deploy - ${{ github.actor }} 🚀
on:
  workflow_run:
    workflows: [ "Build" ]
    types: [ completed ]
    branches: [ main ] # TODO: convert to 'release' when done testing
  workflow_dispatch: # allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: ⬆️ Download image artifact
        uses: actions/download-artifact@v4
        with:
          path: "*.tar.gz"

      - name: Display structure of downloaded files
        run: ls -R

      - name: 🔐 Setup SSH key
        run: |
          echo "${{ secrets.EC2_KEY }}" > key.pem
          chmod 600 key.pem

      - name: 📤 Copy to EC2
        run: |
          scp -i key.pem -o StrictHostKeyChecking=no \
          country-api.tar.gz \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/ec2-user/deploy/

      - name: 🚀 Deploy Container on EC2
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd ~/deploy
          gunzip -f country-api.tar.gz
          docker load < country-api.tar
          
          docker stop country-api || true && docker rm country-api || true
          
          docker run -d \
            --restart unless-stopped \
            --network country-net \
            -e SPRING_DATASOURCE_URL=${{ secrets.RDS_DATASOURCE_URL }} \
            -e SPRING_DATASOURCE_USERNAME=${{ secrets.RDS_DATASOURCE_USERNAME }} \
            -e SPRING_DATASOURCE_PASSWORD=${{ secrets.RDS_DATASOURCE_PASSWORD }} \
            --name country-api \
            country-api:${{ github.sha }}
          EOF