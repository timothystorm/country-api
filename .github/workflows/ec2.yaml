name: Deploy
run-name: 🚀 Deploy - ${{ github.actor }}
on:
  workflow_call: # chainable
    secrets:
      EC2_USER:
        required: true
      EC2_HOST:
        required: true
      EC2_KEY:
        required: true
      RDS_DATASOURCE_URL:
        required: true
      RDS_DATASOURCE_USERNAME:
        required: true
      RDS_DATASOURCE_PASSWORD:
        required: true

jobs:
  ec2:
    runs-on: ubuntu-latest

    steps:
      # only works when run in same workflow scope as actions/upload-artifact@v4 - see: release.yaml
      - name: ⬇️ Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: country-api

      - name: 🔐 Setup SSH key
        run: |
          echo "${{ secrets.EC2_KEY }}" > key.pem
          chmod 600 key.pem
      - name: Debug available environment
        run: printenv | sort

      - name: 📤 Copy to EC2
        run: |
          scp -i key.pem -o StrictHostKeyChecking=no \
          country-api.tar.gz \
          "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/release/"

      - name: 🚀 Deploy Container on EC2
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" << 'EOF'
          cd ~/release
          gunzip -f country-api.tar.gz
          
          docker image prune -a --force --filter "until=4h"
          docker load < country-api.tar
          docker stop country-api || true && docker rm country-api || true
          docker run -d \
            --restart unless-stopped \
            --network country-net \
            -e SPRING_DATASOURCE_URL=${{ secrets.RDS_DATASOURCE_URL }} \
            -e SPRING_DATASOURCE_USERNAME=${{ secrets.RDS_DATASOURCE_USERNAME }} \
            -e SPRING_DATASOURCE_PASSWORD=${{ secrets.RDS_DATASOURCE_PASSWORD }} \
            -p 8080:8080 \
            --name country-api \
            country-api:${{ github.sha }}
          EOF